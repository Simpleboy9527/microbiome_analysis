---
title: "hy-2024"
author: "xh"
date: "2024-02-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(qiime2R)
library(tidyverse)
library(ggplot2)
library(ggsignif)

#alpha diversity function
alpha_plot <- function(alpha_diversity_qza,metadata,compaired,level,color_value){
  data <- as.data.frame(read_qza(alpha_diversity_qza)$data)
  if (colnames(data)[1] == "shannon_entropy") {
    colnames(data)[1] <- "Shannon Index"
  } else if (colnames(data)[1] == "pielou_evenness") {
    colnames(data)[1] <- "Pielou's evenness"
  } else if (colnames(data)[1] == "faith_pd") {
    colnames(data)[1] <- "Faith's PD"
  } else if (colnames(data)[1] == "observed_features") {
    colnames(data)[1] <- "Observed features"
  }
  sample_columns <- grep("^sample", colnames(metadata), value = TRUE) #获取样品列
  data <- data[rownames(data) %in% metadata[,sample_columns],,drop = F] 
  name <- colnames(data)[1] 
  data$group <- metadata$group[match(rownames(data), metadata[,sample_columns])] #添加分组信息
  data$group <- factor(data$group, levels = level) #设置分组顺序
#显著检验
p <- ggplot(data, aes(group,data[,name])) +
  geom_boxplot(alpha = 0.7, 
               size = 0.5,
               width = 0.6) +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin.., ), width = 0.1, color = "black") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax.., ), width = 0.1, color = "black") +
  theme_classic() +
  geom_jitter( 
              size = 1.5, 
              alpha = 0.7, 
              aes(color = group),
              show.legend = FALSE,
              width = 0.02) +
  scale_color_manual(values = color_value) +
  xlab(NULL)+
  theme(axis.title = element_text(size = 8,face = "bold"),    
              axis.text = element_text(size = 8,face = "bold"),     
        legend.text = element_text(size = 2,face = "bold"),
        legend.title = element_text(size = 2,face = "bold")) +
  ylab(name) +
  geom_signif(comparisons = compaired,
              family =  "bold",
                size = 0.5,
                textsize= 2,
                step_increase = 0.05,
                map_signif_level = T, #修改参数map_signif_level=TRUE
                test = t.test)
return(p)
}

#exmaple
shannon <- "C:/Users/16236/Downloads/hy-11/shannon_vector.qza"
compaired <- list(c("C", "PP"))
metadata <- read.table("C:/Users/16236/Desktop/qiime_view/hy/metadata_20230922.txt",header = T,sep = "\t")
p1 <- alpha_plot(shannon,metadata,compaired = compaired,level = c("C","PP"),color_value = c('C' = 'red', 'PP' = 'blue'))
ggsave("shannon.png",p1,width = 2, height = 2, units = "in")





```


#bugbase
```{r}
#all
result_bugbase <- read.table(file = "C:/Users/16236/Desktop/temp/predictions.txt")
result_bugbase <- result_bugbase[order(rownames(result_bugbase)),]
result_bugbase <- result_bugbase[c(1:12,15:32),]
result_bugbase$group <- rep(c("10uM-PP-FMT", "15uM-PP-FMT","C-FMT","C","PP"), each = 6)
result_bugbase$group <- factor(result_bugbase$group, levels = c("C","PP","C-FMT", "10uM-PP-FMT", "15uM-PP-FMT"))
compaired <- list(c("C", "PP"),c("C","C-FMT"),c("C-FMT", "10uM-PP-FMT"),c("15uM-PP-FMT","C-FMT"),c("15uM-PP-FMT", "10uM-PP-FMT"))
for (i in 1:(ncol(result_bugbase)-1)) {
  p1 <- ggplot(result_bugbase, aes(group,result_bugbase[,i])) +
  geom_boxplot(alpha = 0.7, 
               size = 0.5,
               width = 0.6) +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin.., ), width = 0.1, color = "black") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax.., ), width = 0.1, color = "black") +
  theme_classic() +
  geom_jitter( 
              size = 1.5, 
              alpha = 0.7, 
              aes(color = group),
              show.legend = FALSE,
              width = 0.02) +
  scale_color_manual(values = brewer.pal(n = 6, name = "Paired")) +
  xlab(NULL)+
  theme(axis.title = element_text(size = 8,face = "bold"),  
        axis.text.x = element_text(size = 8,face = "bold",angle = 30, hjust = 0.9, vjust = 1),
              axis.text.y = element_text(size = 8,face = "bold"),     
              plot.title = element_text(size = 8,face = "bold"))+
  ylab("Relative Abundance")+
    geom_signif(comparisons = compaired,
              family =  "bold",
                size = 0.5,
                textsize= 2.8,
                step_increase = 0.25,
                map_signif_level = T, #修改参数map_signif_level=TRUE
                test = t.test)
name <- colnames(result_bugbase)[i]
ggsave(paste("bugbase_", name, ".png", sep = ""), width = 2, height = 2, units = "in")
}

#cpp
result_bugbase_cpp <- result_bugbase[c(19:30),]
result_bugbase_cpp$group <- rep(c("C","PP"), each = 6)
result_bugbase_cpp <- result_bugbase_cpp[-2,]
result_bugbase_cpp$group <- factor(result_bugbase_cpp$group, levels = c("C","PP"))
compaired_cpp <- list(c("C", "PP"))
for (i in 1:(ncol(result_bugbase_cpp)-1)) {
  p1 <- ggplot(result_bugbase_cpp, aes(group,result_bugbase_cpp[,i])) +
  geom_boxplot(alpha = 0.7, 
               size = 0.5,
               width = 0.6) +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin.., ), width = 0.1, color = "black") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax.., ), width = 0.1, color = "black") +
  theme_classic() +
  geom_jitter( 
              size = 1.5, 
              alpha = 0.7, 
              aes(color = group),
              show.legend = FALSE,
              width = 0.02) +
  scale_color_manual(values = c('C' = 'red', 'PP' = 'blue')) +
  xlab(NULL)+
  theme(axis.title = element_text(size = 8,face = "bold"),  
        axis.text.x = element_text(size = 8,face = "bold",angle = 30, hjust = 0.9, vjust = 1),
              axis.text.y = element_text(size = 8,face = "bold"),     
              plot.title = element_text(size = 8,face = "bold"))+
  ylab("Relative Abundance")+
    geom_signif(comparisons = compaired_cpp,
              family =  "bold",
                size = 0.5,
                textsize= 2,
                step_increase = 0.05,
                map_signif_level = T, #修改参数map_signif_level=TRUE
                test = t.test)
name <- colnames(result_bugbase_cpp)[i]
ggsave(paste("bugbase_cpp_", name, ".png", sep = ""),p1, width = 2, height = 2, units = "in")
}

#fmt
result_bugbase_fmt <- result_bugbase[c(1:18),]
result_bugbase_fmt$group <- rep(c("10uM-PP-FMT", "15uM-PP-FMT","C-FMT"), each = 6)
result_bugbase_fmt$group <- factor(result_bugbase_fmt$group, levels = c("C-FMT", "10uM-PP-FMT","15uM-PP-FMT"))
compaired_fmt <- list(c("C-FMT", "10uM-PP-FMT"),c("15uM-PP-FMT","C-FMT"),c("15uM-PP-FMT", "10uM-PP-FMT"))
for (i in 1:(ncol(result_bugbase_fmt)-1)) {
  p1 <- ggplot(result_bugbase_fmt, aes(group,result_bugbase_fmt[,i])) +
  geom_boxplot(alpha = 0.7, 
               size = 0.3,
               width = 0.5) +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin.., ), width = 0.1, color = "black") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax.., ), width = 0.1, color = "black") +
  theme_classic() +
  geom_jitter( 
              size = 1.5, 
              alpha = 0.7, 
              aes(color = group),
              show.legend = FALSE,
              width = 0.02) +
  scale_color_manual(values = c('C-FMT'= 'red', '10uM-PP-FMT' = 'blue','15uM-PP-FMT' = 'orange')) +
  xlab(NULL)+
  theme(axis.title = element_text(size = 12,face = "bold"),  
        axis.text.x = element_text(size = 12,face = "bold",angle = 30, hjust = 0.9, vjust = 1),
              axis.text.y = element_text(size = 12,face = "bold"),     
              plot.title = element_text(size = 12,face = "bold"))+
  ylab("Relative Abundance")+
    geom_signif(comparisons = compaired_fmt,
              family =  "bold",
                size = 0.4,
                textsize= 2.5,
                step_increase = 0.1,
                map_signif_level = T, #修改参数map_signif_level=TRUE
                test = t.test)



name <- colnames(result_bugbase_fmt)[i]
ggsave(paste("bugbase_fmt_", name, ".png", sep = ""), width = 3, height = 3, units = "in")

}
```















#beta_diversity

```{r}

bray_curtis_distance <- read_qza("c:/Users/16236/Downloads/hy-11/bray_curtis_pcoa_results.qza")$data

jaccard_distance <- read_qza("c:/Users/16236/Downloads/hy-11/jaccard_pcoa_results.qza")$data

unweighted_unifrac_distance <- read_qza("c:/Users/16236/Downloads/hy-11/unweighted_unifrac_pcoa_results.qza")$data

weighted_unifrac_distance <- read_qza("c:/Users/16236/Downloads/hy-11/weighted_unifrac_pcoa_results.qza")$data

data <- weighted_unifrac_distance

beta_cpp <- function(distance_qza_site,metadata,color_value){
  distance <- read_qza(distance_qza)$data
x_label<-round(distance$ProportionExplained[1]*100,2) #获取PCoA1的解释度
x_label
y_label<-round(distance$ProportionExplained[2]*100,2) #获取PCoA2的解释度
y_label
distance_vectors <- distance$Vectors #获取PCoA坐标
sample_columns <- grep("^sample", colnames(metadata), value = TRUE) #获取样品列
  distance_vectors <- data[rownames(data) %in% metadata[,sample_columns],,drop = F] 
distance_vectors$Group <- rep(c("C", "PP"), each = 6)
distance_vectors

p <- ggplot(distance_vectors, aes(x = round(distance_vectors$PC1,digits = 2), y = PC2)) +
  geom_point(size = 1.5, aes(color = Group)) + 
  theme_classic()+# Use color aesthetic for points
  scale_color_manual(values = c('C' = 'red', 'PP' = 'blue')) +  # Set point colors
  geom_vline(xintercept = 0, lty = "dashed") +
  geom_hline(yintercept = 0, lty = "dashed") +
  labs(x = paste0("PCoA1 ", x_label, "%"),
       y = paste0("PCoA2 ", y_label, "%")) +
  stat_ellipse(data = distance_vectors,
               geom = "polygon",
               aes(fill = Group),
               alpha = 0.3) +
  scale_fill_manual(values = c("#e31a1c", "#1f78b4"))+
  theme(axis.title = element_text(size = 8,face = "bold"),    
              axis.text = element_text(size = 8,face = "bold"),     
        legend.text = element_text(size = 8,face = "bold"),
        legend.title = element_text(size = 8,face = "bold"),
          panel.border = element_rect(fill=NA,color="black", size=.5, linetype="solid"))  
return(p)
}




betacpp1 <- beta_cpp(bray_curtis_distance)
ggsave("bray_curtis_distance.png",betacpp1,width = 3.2, height = 2.2, units = "in")
betacpp2 <- beta_cpp(jaccard_distance)
ggsave("jaccard_distance.png",betacpp2,width = 3.2, height = 2.2, units = "in")
betacpp3 <- beta_cpp(unweighted_unifrac_distance)
ggsave("unweighted_unifrac_distance.png",betacpp3,width = 3.2, height = 2.2, units = "in")
betacpp4 <- beta_cpp(weighted_unifrac_distance)
ggsave("weighted_unifrac_distance.png",betacpp4,width = 3.2, height = 2.2, units = "in")







distance <- weighted_unifrac_distance
x_label<-round(distance$ProportionExplained[1]*100,2)
x_label
y_label<-round(distance$ProportionExplained[2]*100,2)
y_label
distance_vectors <- distance$Vectors
distance_vectors <- distance_vectors[order(distance_vectors$SampleID),,drop=FALSE][3:14,,drop=FALSE]
distance_vectors$Group <- rep(c("C", "PP"), each = 6)
distance_vectors

p <- ggplot(distance_vectors, aes(x = round(distance_vectors$PC1,digits = 2), y = PC2)) +
  geom_point(size = 1.5, aes(color = Group)) + 
  theme_classic()+# Use color aesthetic for points
  scale_color_manual(values = c('C' = 'red', 'PP' = 'blue')) +  # Set point colors
  geom_vline(xintercept = 0, lty = "dashed") +
  geom_hline(yintercept = 0, lty = "dashed") +
  labs(x = paste0("PCoA1 ", x_label, "%"),
       y = paste0("PCoA2 ", y_label, "%")) +
  scale_x_continuous(breaks = c(-0.10, -0.05, 0.00),
                   labels = c("-0.10", "-0.05", "0.00")) +

  stat_ellipse(data = distance_vectors,
               geom = "polygon",
               aes(fill = Group),
               alpha = 0.3) +
  scale_fill_manual(values = c("#e31a1c", "#1f78b4"))+
  theme(axis.title = element_text(size = 10,face = "bold"),    
              axis.text = element_text(size = 12,face = "bold"),     
        legend.text = element_text(size = 8,face = "bold"),
        legend.title = element_text(size = 8,face = "bold"),
          panel.border = element_rect(fill=NA,color="black", size=.5, linetype="solid"))  

ggsave("weighted_unifrac_distance.png",p,width = 3.2, height = 2.2, units = "in")













```

```{r}
#alpha diversity -hy-12
library(qiime2R)
library(tidyverse)
library(ggplot2)
library(ggsignif)
library(vegan)

shannon <- as.data.frame(read_qza("C:/Users/16236/Downloads/hy-1213//shannon_vector.qza")$data)
shannon
colnames(shannon)[1] <- "Shannon_index"
evenness <- as.data.frame(read_qza("C:/Users/16236/Downloads/hy-1213//evenness_vector.qza")$data)
evenness
faithpd <- as.data.frame(read_qza("c:/Users/16236/Downloads/hy-1213//faith_pd_vector.qza")$data)
faithpd
observed <- as.data.frame(read_qza("c:/Users/16236/Downloads/hy-1213//observed_features_vector.qza")$data)
observed
compaired <- list(c("C-FMT", "10uM-PP-FMT"),c("15uM-PP-FMT","C-FMT"),c("15uM-PP-FMT", "10uM-PP-FMT"))

alpha_plot <- function(data,min,max,name){
    data <- data[order(rownames(data)),,drop=F]
    data <- data[c(13:18,1:12),,drop=F]
  groups_vector <- rep(c("C-FMT", "10uM-PP-FMT","15uM-PP-FMT"), each = 6)
  data$group <- groups_vector
  data$group <- factor(data$group, levels = c("C-FMT", "10uM-PP-FMT", "15uM-PP-FMT"))
#显著检验
  p <- ggplot(data, aes(group,data[,1])) +
  geom_boxplot(alpha = 0.7, 
               size = 0.3,
               width = 0.5) +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin.., ), width = 0.1, color = "black") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax.., ), width = 0.1, color = "black") +
  theme_classic() +
  geom_jitter( 
              size = 1.5, 
              alpha = 0.7, 
              aes(color = group),
              show.legend = FALSE,
              width = 0.02) +
  scale_color_manual(values = c('C-FMT'= 'red', '10uM-PP-FMT' = 'blue','15uM-PP-FMT' = 'orange')) +
   theme(axis.title = element_text(size = 8,face = "bold"),    
              axis.text = element_text(size = 8,face = "bold"),  
         axis.text.x = element_text(size = 8,face = "bold",angle = 30, hjust = 0.9, vjust = 1),
        legend.text = element_text(size = 2,face = "bold"),
        legend.title = element_text(size = 2,face = "bold")) +
  ylab(name) +
    xlab(NULL)+
  scale_y_continuous(limits = c(min, max))+
  geom_signif(comparisons = compaired,
              family =  "bold",
                size = 0.5,
                textsize= 2,
                step_increase = 0.25,
                map_signif_level = T, #修改参数map_signif_level=TRUE
                test = t.test)


return(p)
}

p1 <- alpha_plot(shannon,max = 7.2,min = 2,name = "Shannon Index")
p1
ggsave("C:/Users/16236/Desktop/temp/c_pp_fmt/shannon.png",p1,width = 2, height = 2, units = "in")
p2 <- alpha_plot(evenness,max = 0.8,min = 0.35,name ="Pielou's evenness")
ggsave("C:/Users/16236/Desktop/temp/c_pp_fmt/evenness.png",p2,width = 2, height = 2, units = "in" )
p3 <- alpha_plot(faithpd,max = 28,min = 5,name = "Faith's PD")
ggsave("C:/Users/16236/Desktop/temp/c_pp_fmt/faithpd.png",p3,width =2, height = 2, units = "in" )
p4 <- alpha_plot(observed,max = 550,min = 50,name = "Observed features")
ggsave("C:/Users/16236/Desktop/temp/c_pp_fmt/observed.png",p4,width = 2, height = 2, units = "in" )







#beta_diversity
bray_curtis_distance <- read_qza("c:/Users/16236/Downloads/hy-1213/bray_curtis_pcoa_results.qza")$data

jaccard_distance <- read_qza("c:/Users/16236/Downloads/hy-1213/jaccard_pcoa_results.qza")$data

unweighted_unifrac_distance <- read_qza("c:/Users/16236/Downloads/hy-1213/unweighted_unifrac_pcoa_results.qza")$data

weighted_unifrac_distance <- read_qza("c:/Users/16236/Downloads/hy-1213/weighted_unifrac_pcoa_results.qza")$data












metadata <- read.table("C:/Users/16236/Desktop/qiime_view/hy/metadata_20231122.txt",header = T,sep = "\t")

asv_table <- t(read_qza("c:/Users/16236/Desktop/qiime_view/hy/hy-2023-1217/filtered-table.qza")$data)
asv_table


beta_fmt <- function(data){
distance <- data
x_label<-round(distance$ProportionExplained[1]*100,2)
x_label
y_label<-round(distance$ProportionExplained[2]*100,2)
y_label
distance_vectors <- distance$Vectors
distance_vectors <- distance_vectors[order(distance_vectors$SampleID),,drop=FALSE]
distance_vectors <- distance_vectors[c(13:18,1:12),,drop=F]
distance_vectors$Group <- rep(c("C-FMT", "10uM-PP-FMT","15uM-PP-FMT"), each = 6)
distance_vectors$Group <- factor(distance_vectors$Group, levels = c("C-FMT", "10uM-PP-FMT", "15uM-PP-FMT"))
distance_vectors
p <- ggplot(distance_vectors, aes(x = PC1, y = PC2)) +
  geom_point(size = 2, aes(color = Group)) +
  theme_classic()+# Use color aesthetic for points
  scale_color_manual(values = c('C-FMT'= 'red', '10uM-PP-FMT' = 'blue','15uM-PP-FMT' = 'orange')) +  # Set point colors
  geom_vline(xintercept = 0, lty = "dashed") +
  geom_hline(yintercept = 0, lty = "dashed") +
  labs(x = paste0("PCoA1 ", x_label, "%"),
       y = paste0("PCoA2 ", y_label, "%")) +
  stat_ellipse(data = distance_vectors,
               geom = "polygon",
               aes(fill = Group),
               alpha = 0.3) +
  scale_fill_manual(values = c("#e31a1c", "#1f78b4","orange3"))+  
 theme(axis.title = element_text(size = 8,face = "bold"),    
              axis.text = element_text(size =8,face = "bold"),     
        legend.text = element_text(size = 8,face = "bold"),
        legend.title = element_text(size = 8,face = "bold"),
          panel.border = element_rect(fill=NA,color="black", size=.5, linetype="solid"))   
return(p) 
# Print or display the modified plot
return(p)
}

betafmt1 <- beta_fmt(bray_curtis_distance)
ggsave("C:/Users/16236/Desktop/temp/c_pp_fmt/bray_curtis_distance.png",betafmt1 ,width =3.7, height = 2, units = "in")
betafmt2 <- beta_fmt(jaccard_distance)
ggsave("C:/Users/16236/Desktop/temp/c_pp_fmt/jaccard_distance.png",betafmt2 ,width =3.7, height = 2, units = "in")
betafmt3 <- beta_fmt(unweighted_unifrac_distance)
ggsave("C:/Users/16236/Desktop/temp/c_pp_fmt/unweighted_unifrac_distance.png",betafmt3 ,width = 3.7, height = 2, units = "in")
betafmt4 <- beta_fmt(weighted_unifrac_distance)
ggsave("C:/Users/16236/Desktop/temp/c_pp_fmt/weighted_unifrac_distance.png",betafmt4 ,width = 3.7, height = 2, units = "in")













taxa_barplot_cpp <- function(metadata, SVs, taxonomy, name, order) {
  # List of packages to check and install
p_list <- c("ggplot2", "tidyverse", "qiime2R","dplyr","ggsci")

# Loop through each package in the list
for (p in p_list) {
  # Check if the package is already installed
  if (!requireNamespace(p)) {
    # If not installed, install the package
    install.packages(p)
  }
  
  # Load the package into the current R session
  suppressWarnings(suppressMessages(library(p, character.only = TRUE)))
}


  # Read feature table (SVs) and taxonomy data
  SVs_data <- as.data.frame(read_qza(SVs)$data)
  taxonomy_data <- read_qza(taxonomy)$data %>% parse_taxonomy()

  # Summarize taxa based on specified name
  taxasums <- summarize_taxa(SVs_data, taxonomy_data)[[name]]
  i <- match(name, colnames(taxonomy_data))

  # Rename rows based on taxonomic hierarchy
  new_row_names <- sapply(strsplit(row.names(taxasums), ";"), function(x) paste(x[i], collapse = ";"))
  taxasums$taxa <- new_row_names
  taxasums$taxa[taxasums$taxa == " NA"] <- " Others"
  
  # Order taxa by abundance
  taxasums <- taxasums[order(rowSums(taxasums[, 1:(ncol(taxasums)-1)]), decreasing = TRUE), , drop = TRUE]
  taxasums <- rbind(taxasums[taxasums$taxa != " Others", ], taxasums[taxasums$taxa == " Others", ])

  # If more than 15 taxa, group less abundant ones as "Others"
  if (nrow(taxasums) > 15) {
    taxasums$taxa[16:nrow(taxasums)] <- " Others"
  }

  # Create a data frame with aggregated taxa abundances
  result_df <- taxasums %>%
    group_by(taxa) %>%
    summarise(across(colnames(taxasums)[-ncol(taxasums)], sum))

  result_df <- as.data.frame(result_df)
  row.names(result_df) <- result_df$taxa
  result_df <- result_df[, -1, drop = FALSE]

  # Check if data needs normalization
  column_sums_result_df <- colSums(result_df)
  are_column_sums_equal <- all(column_sums_result_df == column_sums_result_df[1])

  if (are_column_sums_equal) {
    # Normalize data if column sums are equal
    result_df_prop <- result_df / column_sums_result_df[1]

    # Create a wide matrix for plotting
    wide_matrix <- rownames_to_column(result_df_prop, var = "level")

    # Convert wide matrix to long matrix
    long_matrix <- gather(wide_matrix, key = "Sample", value = "Value", -level)

    # Match group information from metadata
    long_matrix$group <- metadata$group[match(long_matrix$Sample, metadata$sample.id)]

    # Set color palettes
    col = pal_d3("category20")(20)
    col2 = pal_d3("category20", alpha = 0.5)(20)
    mypal = c(col, col2[-8])

    # Order taxa and groups for plotting
    order_x = apply(result_df_prop[, 1:ncol(result_df_prop)], 1, sum)
    order_x = order_x[order(order_x, decreasing = TRUE)]
    site <- match(" Others", names(order_x))

    if (!is.na(site) && site != 1) {
      order_x <- order_x[c(site, 1:(site-1), (site+1):length(order_x))]
    }

    long_matrix$level = factor(long_matrix$level, levels = names(order_x), ordered = TRUE)
    long_matrix$group = factor(long_matrix$group, levels = order, ordered = TRUE)

    # Create and customize the bar plot using ggplot2
    temp_plot <- ggplot(long_matrix, aes(x = Sample, weight = Value, fill = level)) +
      geom_bar(aes(x = factor(Sample, levels = unique(long_matrix$Sample))), position = "stack") +
      theme_classic() +
      scale_fill_manual(values = mypal[3:18]) +
      facet_grid(~ group, scales = "free_x", switch = "x") +
      theme(
        axis.ticks.x = element_blank(),
        legend.position = "top",
        axis.text.x = element_blank(),
        strip.background = element_blank()
      ) +
      xlab("Groups") +
      scale_y_continuous(
        name = "Relative abundance (%)",
        limits = c(0, 1),
        breaks = seq(0, 1, 0.25),
        labels = paste(seq(0, 100, 25))
      ) +
      labs(x = NULL, fill = name[1]) +
      theme(
        legend.position = "right",
        axis.title = element_text(face = "bold", size = 12, colour = "black", family = "Arial"),
        axis.text = element_text(face = "bold", size = 12, color = "black", family = "Arial"),
        strip.text.x = element_text(face = "bold", size = 12, color = "black", family = "Arial"),
        panel.grid = element_blank(),
        legend.title = element_text(face = "bold", size = 12, color = "black", family = "Arial"),
        legend.text = element_text(face = "bold.italic", size = 12, color = "black", family = "Arial")
      )

    return(temp_plot)
  } else {
    print("Your ASV table is not equal.")
  }
}


metadata<-read.table("C:/Users/16236/Desktop/qiime_view/hy/metadata_20231122.txt",header = T,sep = "\t")
metadata

order <- c("C_FMT","10uM_PP_FMT", "15uM_PP_FMT")

SVs <- "C:/Users/16236/Desktop/qiime_view/hy/hy-2023-1217/filtered-table.qza"

taxonomy <- "C:/Users/16236/Desktop/qiime_view/hy/hy-2023-1217/taxonomy.qza"

name <- c("Class","Family","Genus","Order","Phylum","Species")

for (i  in name) {
  print(i)
 temp_plot <-  taxa_barplot_cpp(metadata = metadata,SVs = SVs,taxonomy = taxonomy,name = i,order = order)

  ggsave(paste("taxa_barplot_fmt",i,".png"),temp_plot,width =8, height = 5, units = "in")
 
}




order <- c("C","PP")
metadata<-read.table("C:/Users/16236/Desktop/qiime_view/hy/metadata_20230922.txt",header = T,sep = "\t")

SVs<-"C:/Users/16236/Desktop/qiime_view/hy/hy-2023-11/filtered-table-49728-noAST.qza"

taxonomy<-"C:/Users/16236/Desktop/qiime_view/hy/hy-2023-11/taxonomy.qza"

for (i  in name) {
  print(i)
 temp_plot <-  taxa_barplot_cpp(metadata = metadata,SVs = SVs,taxonomy = taxonomy,name = i,order = order)

  ggsave(paste("taxa_barplot_cpp",i,".png"),temp_plot,width =8, height = 5, units = "in")
 
}









```


```{r}
#heatmap

library(dplyr)
library(microbiomeMarker)
library(RColorBrewer)
library(gtable)
library(grid)
library(ggplot2)
library(stringr)
library(ComplexHeatmap)
library(extrafont)
library(circlize)
library (ggplot2)
library (reshape2)#数据转换
library(ggsci)


res_pp_c <- import_qiime2('C:/Users/16236/Desktop/temp/qiime_temp/raref-filtered-table.qza',taxa_qza = 'C:/Users/16236/Desktop/temp/qiime_temp/taxonomy.qza',
                     sam_tab = 'C:/Users/16236/Desktop/qiime_view/hy/metadata_20230922.txt')


result_pp_c <- run_ancom(
  res_pp_c,
  group="group",
  taxa_rank = "none",
  p_adjust =  "BH",
  pvalue_cutoff = 0.05, 
)

res_pp_c <- normalize(res_pp_c, "TSS")
result_table <- data.frame(result_pp_c@marker_table)
pp_corder <- result_table[order(result_table$enrich_group, -result_table$ef_CLR_diff_mean),,drop = F]
pp_corder
taxatable_cpp <- as.data.frame(res_pp_c@tax_table)
taxatable_cpp$feature <- rownames(taxatable_cpp)
taxatable_cpp
otutable <- as.data.frame(res_pp_c@otu_table)
otutable$feature <- rownames(otutable)
otutable
merged_data <- merge(pp_corder, taxatable_cpp, by = "feature")
merged_data <- merge(merged_data, otutable, by = "feature")
merged_data

merged_data$Kingdom <- ifelse(!is.na(merged_data$Kingdom), paste0("k_", merged_data$Kingdom), NA)
merged_data$Phylum <- ifelse(!is.na(merged_data$Phylum), paste0("p_", merged_data$Phylum), NA)
merged_data$Class <- ifelse(!is.na(merged_data$Class), paste0("c_", merged_data$Class), NA)
merged_data$Order <- ifelse(!is.na(merged_data$Order), paste0("o_", merged_data$Order), NA)
merged_data$Family <- ifelse(!is.na(merged_data$Family), paste0("f_", merged_data$Family), NA)
merged_data$Genus <- ifelse(!is.na(merged_data$Genus), paste0("g_", merged_data$Genus), NA)
merged_data$Species <- ifelse(!is.na(merged_data$Species), paste0("s_", merged_data$Species), NA)
merged_data

max_lengths <- sapply(merged_data[,5:11], function(x) max(nchar(as.character(x)), na.rm = TRUE))

for (col in names(merged_data[, 5:11])) {
  if (is.character(merged_data[[col]])) {
    # Replace NA with an empty string before padding
    merged_data[[col]][is.na(merged_data[[col]])] <- ""
    # Pad the strings
    merged_data[[col]] <- str_pad(merged_data[[col]], width = max_lengths[col], side = "right")
  }
}

merged_data$taxa <- do.call(paste, c(merged_data[6:11], sep = "; "))

merged_data <- merged_data[,12:24]
merged_data <- merged_data[,order(colnames(merged_data)),drop = F]

merged_data$diff <-  rowMeans(merged_data[, 1:6]) -  rowMeans(merged_data[, 7:12])
merged_data <- merged_data[order(merged_data$diff,decreasing = T),]

merged_data$order <- seq_len(nrow(merged_data))
merged_data$order <- factor(merged_data$order, levels = unique(merged_data$order), ordered = TRUE)

  
annotation_text <- merged_data$taxa

long_matrix <- melt(merged_data[,-14])
  
long_matrix$order <- factor(long_matrix$order , levels = unique(long_matrix$order), ordered = TRUE)
long_matrix$order <- factor(long_matrix$order, levels = rev(unique(long_matrix$order)), ordered = TRUE)

library(ggplot2)
# Your existing ggplot code
my_color_palette <- colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))
p1 <- ggplot(long_matrix, aes(x = variable, y = order)) +
  theme_classic() +
  scale_fill_gradientn(colors = my_color_palette(100))+
  geom_tile(aes(fill = value)) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.x = element_text(face = "bold", size = 14, family = "Consolas"),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line = element_blank(),
    legend.title = element_text(size = 14, color = "black", face = "bold",angle = 90,margin = margin(l = -100,b = -250)),
    legend.text = element_text(size = 14, color = "black", face = "bold"),
    legend.key.width = unit(0.3, "in"),
    legend.key.height = unit(1, "in"),
    legend.box.margin = margin(l = 0.1, unit = "in"),
    legend.title.align = 0.5 
  ) +
  labs(fill = "Relative Abundance") +
  annotate(
       size = 5,
    geom = "text",
    x = -20,
    y = 1:length(annotation_text),
    label = rev(annotation_text),
    family = "Consolas",
    color = "black",
    hjust = 0,
    fontface = "bold.italic"
  ) 

# Save the plot
ggsave("temp.png", p1, width = 23, height = 10, units = "in")



#genus 开始画
annotation_text

annotation_text_genus <- lapply(annotation_text, function(x) sub(".*o_", " o_", x))

p2 <- ggplot(long_matrix, aes(x = variable, y = order)) +
  theme_classic() +
   scale_fill_gradientn(colors = my_color_palette(100))+
  geom_tile(aes(fill = value)) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.x = element_text(face = "bold", size = 14, family = "Consolas"),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line = element_blank(),
    legend.title = element_text(size = 14, color = "black", face = "bold",angle = 90,margin = margin(l = -100,b = -250)),
    legend.text = element_text(size = 14, color = "black", face = "bold"),
    legend.key.width = unit(0.3, "in"),
    legend.key.height = unit(1, "in"),
    legend.box.margin = margin(l = 0.1, unit = "in"),
    legend.title.align = 0.5 
  ) +
  labs(fill = "Relative Abundance") +
  annotate(
    size = 5,
    geom = "text",
    x = -15,
    y = 1:length(annotation_text_genus),
    label = rev(annotation_text_genus),
    family = "Consolas",
    color = "black",
    hjust = 0,
    fontface = "bold.italic"
)

# Save the plot
ggsave("temp_genus.png", p2, width = 18.5, height = 8, units = "in")






res_C_PP_FMT <- import_qiime2('C:/Users/16236/Desktop/qiime_view/hy/hy-2023-1217/filtered-sample-table.qza',taxa_qza = 'c:/Users/16236/Desktop/qiime_view/hy/hy-2023-1217/taxonomy.qza',
                     sam_tab = 'c:/Users/16236/Desktop/qiime_view/hy/hy-2023-1217/metadata_20231122.tsv')

result_C_PP_FMT <- run_ancom(
  res_C_PP_FMT,
  group="group",
  taxa_rank = "none",
  p_adjust =  "BH",
  pvalue_cutoff = 0.05
)


res_pp_c_fmt <- normalize(res_C_PP_FMT, "TSS")
result_table <- data.frame(result_C_PP_FMT@marker_table)
pp_corder <- result_table[order(result_table$enrich_group, -result_table$ef_CLR_F_statistic),,drop = F]
pp_corder
taxatable_fmt <- as.data.frame(res_pp_c_fmt@tax_table)
taxatable_fmt$feature <- rownames(taxatable_fmt)
taxatable_fmt
otutable <- as.data.frame(res_pp_c_fmt@otu_table)
otutable$feature <- rownames(otutable)
otutable

merged_data <- merge(pp_corder, taxatable_fmt , by = "feature")
merged_data <- merge(merged_data, otutable, by = "feature")
merged_data

merged_data$Kingdom <- ifelse(!is.na(merged_data$Kingdom), paste0("k_", merged_data$Kingdom), NA)
merged_data$Phylum <- ifelse(!is.na(merged_data$Phylum), paste0("p_", merged_data$Phylum), NA)
merged_data$Class <- ifelse(!is.na(merged_data$Class), paste0("c_", merged_data$Class), NA)
merged_data$Order <- ifelse(!is.na(merged_data$Order), paste0("o_", merged_data$Order), NA)
merged_data$Family <- ifelse(!is.na(merged_data$Family), paste0("f_", merged_data$Family), NA)
merged_data$Genus <- ifelse(!is.na(merged_data$Genus), paste0("g_", merged_data$Genus), NA)
merged_data$Species <- ifelse(!is.na(merged_data$Species), paste0("s_", merged_data$Species), NA)
merged_data



max_lengths <- sapply(merged_data[,5:11], function(x) max(nchar(as.character(x)), na.rm = TRUE))

for (col in names(merged_data[, 5:11])) {
  if (is.character(merged_data[[col]])) {
    # Replace NA with an empty string before padding
    merged_data[[col]][is.na(merged_data[[col]])] <- ""
    # Pad the strings
    merged_data[[col]] <- str_pad(merged_data[[col]], width = max_lengths[col], side = "right",pad = " ")
  }
}
merged_data$taxa <- do.call(paste, c(merged_data[6:11], sep = "; "))

merged_data <- merged_data[,12:30]

merged_data <- merged_data[,order(colnames(merged_data),decreasing = FALSE)]
merged_data <- merged_data[,c(13:18, 1:12,19)]
merged_data$C_FMT_mean <- rowMeans(merged_data[, 1:6])
merged_data$PP_FMT_10 <- rowMeans(merged_data[, 7:12])
merged_data$PP_FMT_15 <- rowMeans(merged_data[, 13:18])

# Create an empty vector to store the enrich_group values
merged_data$enrich_group <- character(nrow(merged_data))

for (i in 1:nrow(merged_data)) {
  if (merged_data$C_FMT_mean[i] > merged_data$PP_FMT_10[i] | merged_data$PP_FMT_15[i] > merged_data$PP_FMT_10[i]) {
    if (merged_data$C_FMT_mean[i] > merged_data$PP_FMT_15[i]) {
      merged_data$enrich_group[i] <- "C_FMT"
    } else {
      merged_data$enrich_group[i] <- "15uM_PP_FMT"
    }
  } else {
    merged_data$enrich_group[i] <- "10uM_PP_FMT"
  }
}

merged_data <- merged_data[order(merged_data$enrich_group),]


merged_data$enrich_group <- factor(merged_data$enrich_group, levels = c("C_FMT", "10uM_PP_FMT", "15uM_PP_FMT"))

# 使用 dplyr 进行排序和筛选
merged_data_fmt <- merged_data %>%
  arrange(enrich_group, desc(case_when(
    enrich_group == "C_FMT" ~ C_FMT_mean,
    enrich_group == "10uM_PP_FMT" ~ PP_FMT_10,
    enrich_group == "15uM_PP_FMT" ~ PP_FMT_15
  )))

merged_data_fmt$order <- seq_len(nrow(merged_data_fmt))
merged_data_fmt$order <- factor(merged_data_fmt$order, levels = unique(merged_data_fmt$order), ordered = TRUE)




annotation_text <- merged_data_fmt$taxa

long_matrix <- melt(merged_data_fmt[,c(1:18,24)])
  
long_matrix$order <- factor(long_matrix$order , levels = unique(long_matrix$order), ordered = TRUE)
long_matrix$order <- factor(long_matrix$order, levels = rev(unique(long_matrix$order)), ordered = TRUE)


p3 <- ggplot(long_matrix, aes(x = variable, y = order)) +
  theme_classic() +
  scale_fill_gradientn(colors = my_color_palette(100))+
  geom_tile(aes(fill = value)) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.x = element_text(face = "bold", size = 15, family = "Consolas",angle = 30, hjust = 0.9, vjust = 1),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line = element_blank(),
    legend.title = element_text(size = 14, color = "black", face = "bold",angle = 90,margin = margin(l = -90,b = -250)),
    legend.text = element_text(size = 14, color = "black", face = "bold"),
    legend.key.width = unit(0.3, "in"),
    legend.key.height = unit(1, "in"),
    legend.box.margin = margin(l = 0.1, unit = "in"),
    legend.title.align = 0.5 
  ) +
  labs(fill = "Relative Abundance") +
  annotate(
    size = 5,
    geom = "text",
    x = -20,
    y = 1:length(annotation_text),
    label = rev(annotation_text),
    family = "Consolas",
    color = "black",
    hjust = 0,
    fontface = "bold.italic"
)

# Save the plot
ggsave("temp-fmt.png", p3, width = 26, height = 10, units = "in")



#order 开始画，不到order删除
filterd_order_fmt <- merged_data_fmt[grep("o_", merged_data_fmt$taxa), , drop = FALSE]
filterd_order_fmt $order <- seq_len(nrow(filterd_order_fmt))
filterd_order_fmt$order <- factor(filterd_order_fmt$order, levels = unique(filterd_order_fmt$order), ordered = TRUE)




annotation_text <- filterd_order_fmt$taxa

long_matrix <- melt(filterd_order_fmt[,c(1:18,24)])
  
long_matrix$order <- factor(long_matrix$order , levels = unique(long_matrix$order), ordered = TRUE)
long_matrix$order <- factor(long_matrix$order, levels = rev(unique(long_matrix$order)), ordered = TRUE)

annotation_text_order <- lapply(annotation_text, function(x) sub(".*o_", " o_", x))

p4 <- ggplot(long_matrix, aes(x = variable, y = order)) +
  theme_classic() +
  scale_fill_gradientn(colors = my_color_palette(100))+
  geom_tile(aes(fill = value)) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.x = element_text(face = "bold", size = 14, family = "Consolas",angle = 30, hjust = 0.9, vjust = 1),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line = element_blank(),
    legend.title = element_text(size = 14, color = "black", face = "bold",angle = 90,margin = margin(l = -80,b = -250)),
    legend.text = element_text(size = 14, color = "black", face = "bold"),
    legend.key.width = unit(0.3, "in"),
    legend.key.height = unit(1, "in"),
    legend.box.margin = margin(l = 0.1, unit = "in"),
    legend.title.align = 0.5 
  ) +
  labs(fill = "Relative Abundance") +
  annotate(
    size = 5,
    geom = "text",
    x = -18,
    y = 1:length(annotation_text_order),
    label = rev(annotation_text_order),
    family = "Consolas",
    color = "black",
    hjust = 0,
    fontface = "bold.italic"
)

# Save the plot
ggsave("temp_fmt_order.png", p4, width = 18.5, height = 8, units = "in")





##all
refseq_pp_c_filter <- as.data.frame(res_pp_c@refseq)[result_pp_c@marker_table[["feature"]],,drop = FALSE]


refseq_res_C_PP_FMT_filter <- as.data.frame(res_pp_c_fmt@refseq)[result_C_PP_FMT@marker_table[["feature"]],,drop = FALSE]

Asv_all <- union(refseq_pp_c_filter$x, refseq_res_C_PP_FMT_filter$x)


#提取对应丰度表
otutable_cpp <- as.data.frame(res_pp_c@otu_table)
otutable_cpp$seq <- res_pp_c@refseq
otutable_cpp <- otutable_cpp[as.character(otutable_cpp$seq) %in% Asv_all,]

otutable_fmt <- as.data.frame(res_pp_c_fmt@otu_table)
otutable_fmt$seq <- res_pp_c_fmt@refseq
otutable_fmt <- otutable_fmt[as.character(otutable_fmt$seq) %in% Asv_all,]

#taxon
otutable_cpp$feature <- rownames(otutable_cpp)
otutable_fmt$feature <- rownames(otutable_fmt)

temp_merge_cpp <- merge(otutable_cpp,taxatable_cpp,by = "feature")
temp_merge_fmt <- merge(otutable_fmt,taxatable_fmt,by = "feature")

temp_merge_cpp$seq <- as.character(temp_merge_cpp$seq)
temp_merge_fmt$seq <- as.character(temp_merge_fmt$seq)

result_all <- merge(temp_merge_fmt,temp_merge_cpp,by = "seq",all = T)

result_all$Kingdom.x <- ifelse(!is.na(result_all$Kingdom.x), paste0("k_", result_all$Kingdom.x), NA)
result_all$Phylum.x <- ifelse(!is.na(result_all$Phylum.x), paste0("p_", result_all$Phylum.x), NA)
result_all$Class.x <- ifelse(!is.na(result_all$Class.x), paste0("c_", result_all$Class.x), NA)
result_all$Order.x <- ifelse(!is.na(result_all$Order.x), paste0("o_", result_all$Order.x), NA)
result_all$Family.x <- ifelse(!is.na(result_all$Family.x), paste0("f_", result_all$Family.x), NA)
result_all$Genus.x <- ifelse(!is.na(result_all$Genus.x), paste0("g_", result_all$Genus.x), NA)
result_all$Species.x <- ifelse(!is.na(result_all$Species.x), paste0("s_", result_all$Species.x), NA)
result_all





result_all$Kingdom.y <- ifelse(!is.na(result_all$Kingdom.y), paste0("k_", result_all$Kingdom.y), NA)
result_all$Phylum.y <- ifelse(!is.na(result_all$Phylum.y), paste0("p_", result_all$Phylum.y), NA)
result_all$Class.y <- ifelse(!is.na(result_all$Class.y), paste0("c_", result_all$Class.y), NA)
result_all$Order.y <- ifelse(!is.na(result_all$Order.y), paste0("o_", result_all$Order.y), NA)
result_all$Family.y <- ifelse(!is.na(result_all$Family.y), paste0("f_", result_all$Family.y), NA)
result_all$Genus.y <- ifelse(!is.na(result_all$Genus.y), paste0("g_", result_all$Genus.y), NA)
result_all$Species.y <- ifelse(!is.na(result_all$Species.y), paste0("s_", result_all$Species.y), NA)
result_all

 result_all[,21:27][is.na(result_all[,21:27])] <- result_all[,41:47][is.na(result_all[,21:27])]
 
max_lengths <- sapply(result_all[,21:27], function(x) max(nchar(as.character(x)), na.rm = TRUE))

for (col in names(result_all[, 21:27])) {
  if (is.character(result_all[[col]])) {
    # Replace NA with an empty string before padding
    result_all[[col]][is.na(result_all[[col]])] <- ""
    # Pad the strings
    result_all[[col]] <- str_pad(result_all[[col]], width = max_lengths[col], side = "right", pad = " ")
  }
}


result_all$taxa <- do.call(paste, c(result_all[22:27], sep = "; "))

result_all <- result_all[,order(colnames(result_all))]

result_all <- result_all[,c(1:24,39:44,48)]

result_all[is.na(result_all)] <- 0

result_all <- result_all[,c(19:30,13:18,1:12,31)]

library(ggtree)



dist_matrix <- dist(result_all[,-31])

# 进行 complete-linkage 层次聚类
hclust_result <- hclust(dist_matrix, method = "complete")

# 绘制树状图
plot(hclust_result, main = "Complete-linkage Hierarchical Clustering Dendrogram")

result_all <- result_all[hclust_result[["order"]],]



result_all$order <- seq_len(nrow(result_all))
result_all$order <- factor(result_all$order, levels = unique(result_all$order), ordered = TRUE)




annotation_text <- result_all$taxa

long_matrix <- melt(result_all[,c(1:30,32)])
  
long_matrix$order <- factor(long_matrix$order , levels = unique(long_matrix$order), ordered = TRUE)
long_matrix$order <- factor(long_matrix$order, levels = rev(unique(long_matrix$order)), ordered = TRUE)


p5 <- ggplot(long_matrix, aes(x = variable, y = order)) +
  theme_classic() +
  scale_fill_gradientn(colors = my_color_palette(100))+
  geom_tile(aes(fill = value)) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.x = element_text(face = "bold", size = 15, family = "Consolas",angle = 30, hjust = 0.9, vjust = 1),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line = element_blank(),
    legend.title = element_text(size = 14, color = "black", face = "bold",angle = 90,margin = margin(l = -90,b = -250)),
    legend.text = element_text(size = 14, color = "black", face = "bold"),
    legend.key.width = unit(0.3, "in"),
    legend.key.height = unit(1, "in"),
    legend.box.margin = margin(l = 0.1, unit = "in"),
    legend.title.align = 0.5 
  ) +
  labs(fill = "Relative Abundance") +
  annotate(
    size = 5,
    geom = "text",
    x = -28.5,
    y = 1:length(annotation_text),
    label = rev(annotation_text),
    family = "Consolas",
    color = "black",
    hjust = 0,
    fontface = "bold.italic"
)

# Save the plot
ggsave("temp-all.png", p5, width = 29, height = 10, units = "in")






#order

filterd_order_all <- result_all[grep("o_", result_all$taxa), , drop = FALSE]
filterd_order_all $order <- seq_len(nrow(filterd_order_all))
filterd_order_all$order <- factor(filterd_order_all$order, levels = unique(filterd_order_all$order), ordered = TRUE)




annotation_text <- filterd_order_all$taxa

long_matrix <- melt(filterd_order_all[,c(1:30,32)])
  
long_matrix$order <- factor(long_matrix$order , levels = unique(long_matrix$order), ordered = TRUE)
long_matrix$order <- factor(long_matrix$order, levels = rev(unique(long_matrix$order)), ordered = TRUE)

annotation_text_order <- lapply(annotation_text, function(x) sub(".*o_", " o_", x))

p6 <- ggplot(long_matrix, aes(x = variable, y = order)) +
  theme_classic() +
  scale_fill_gradientn(colors = my_color_palette(100))+
  geom_tile(aes(fill = value)) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.x = element_text(face = "bold", size = 14, family = "Consolas",angle = 30, hjust = 0.9, vjust = 1),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line = element_blank(),
    legend.title = element_text(size = 14, color = "black", face = "bold",angle = 90,margin = margin(l = -80,b = -250)),
    legend.text = element_text(size = 14, color = "black", face = "bold"),
    legend.key.width = unit(0.3, "in"),
    legend.key.height = unit(1, "in"),
    legend.box.margin = margin(l = 0.1, unit = "in"),
    legend.title.align = 0.5 
  ) +
  labs(fill = "Relative Abundance") +
  annotate(
    size = 5,
    geom = "text",
    x = -25,
    y = 1:length(annotation_text_order),
    label = rev(annotation_text_order),
    family = "Consolas",
    color = "black",
    hjust = 0,
    fontface = "bold.italic"
)

# Save the plot
ggsave("temp_all_order.png", p6, width = 22, height = 8, units = "in")

















```


```{r}
## PICRUSt2_result
 ROS_relative <- read.csv("C:/Users/16236/Desktop/temp/ROS_relative_ec.csv", header=FALSE)
colnames(ROS_relative) <- ROS_relative[1,]
ROS_relative <- ROS_relative[-1,]

ROS_relative$description <- lapply(ROS_relative$description, function(x) sub("[,;].*", "", x))
ROS_relative$description  <- lapply(ROS_relative$description , toupper)

rownames(ROS_relative) <- ROS_relative$description
ROS_relative <- ROS_relative[,3:32]
ROS_relative <- ROS_relative[,order(colnames(ROS_relative))]
ROS_relative <- ROS_relative[,c(19:30,13:18,1:12)]
ROS_relative <- t(ROS_relative)


rowname <- rownames(ROS_relative)
ROS_relative <- apply(ROS_relative, 2, as.numeric)
 rownames(ROS_relative) <- rowname
# library(pheatmap)
# ROS_map <- pheatmap::pheatmap(ROS_relative,
#                               cluster_rows = F,
#                               cluster_cols = F)
# ROS_map




ROS_relative <- ROS_relative[order(rownames(ROS_relative)),]
ROS_relative <- as.data.frame(ROS_relative)
ROS_relative$group <- rep(c("10uM-PP-FMT", "15uM-PP-FMT","C-FMT","C","PP"), each = 6)
ROS_relative$group <- factor(ROS_relative$group, levels = c("C","PP","C-FMT", "10uM-PP-FMT", "15uM-PP-FMT"))

for (i in 1:(ncol(ROS_relative)-1)) {
  p1 <- ggplot(ROS_relative, aes(group,ROS_relative[,i])) +
  geom_boxplot(alpha = 0.7, 
               size = 0.5,
               width = 0.3) +
    stat_boxplot(geom = "errorbar", aes(ymax = ..ymin.., ), width = 0.1, color = "black") +
    stat_boxplot(geom = "errorbar", aes(ymin = ..ymax.., ), width = 0.1, color = "black") +
  theme_classic() +
  geom_jitter( 
              size = 3, 
              alpha = 0.7, 
              aes(color = group),
              show.legend = FALSE,
              width = 0.02,
              height = 0) +
  scale_color_manual(values = brewer.pal(n = 6, name = "Paired")) +
  xlab(NULL)+
  theme(axis.title = element_text(size = 8,face = "bold"),  
        axis.text.x = element_text(size = 8,face = "bold",angle = 30, hjust = 0.5, vjust = .5),
              axis.text.y = element_text(size = 8,face = "bold"),     
              plot.title = element_text(size = 8,face = "bold"))+
  ylab("Proportion of sequences (%)")+
    ggtitle(colnames(ROS_relative)[i])+
    stat_compare_means(label="p.signif", method="t.test",
                       ref.group = "C")
name <- colnames(ROS_relative)[i]
ggsave(paste( name, ".png", sep = ""), p1,width = 3, height = 3, units = "in")
}












```




```






